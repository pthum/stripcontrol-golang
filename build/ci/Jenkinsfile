library 'jshared' _

properties([
    parameters([booleanParam('deployParam')])
  ])
def serviceName = "stripcontrol-go"
def deploy = params.deployParam
def buildUtil = new de.backenddev.jshared.BuildUtil(this)
def tag

node {
  stage("prepare") {
      tag = buildUtil.cleanCheckout() 
  }

  stage("test") {
    dir("build") {
        sh "./unit-test.sh $serviceName"
    }
    junit allowEmptyResults: true, testResults: 'report.xml'
    cobertura autoUpdateHealth: false, autoUpdateStability: false, coberturaReportFile: 'coverage.xml', conditionalCoverageTargets: '70, 0, 0', failUnhealthy: false, failUnstable: false, lineCoverageTargets: '70, 0, 0', maxNumberOfBuilds: 0, methodCoverageTargets: '80, 0, 0', onlyStable: false, sourceEncoding: 'ASCII', zoomCoverageChart: false
  }

  stage("build") {
    def buildArgs=[:]
    def platforms=["linux/arm64", "linux/arm/v7"]
    def additionalArgs = "--target=finalimage"
    buildUtil.buildAndPushImage(serviceName, tag, "build/package/Dockerfile", ".",buildArgs, platforms, additionalArgs)
  }

  stage("deploy") {
    if(buildUtil.hasBranchDeployConfiguration() && params.deployParam){
      buildUtil.deployImageRemotely(serviceName, tag)
    }
  }
}